# R12 LOCK — Cashout gates + status-preserving structured errors

**Date (local):** 2026-01-29 03:05:05
**Branch:** m37-from-m36-final
**Commit:** bde1bf3
**Scope:** Backend /wallet cashout gating + error transport/status integrity (no behavior drift outside gating)

---

## What R12 locks (the non-negotiables)

### A) Cashout is **gated** by:
1) **Identity verification** must be erified
2) **Bank info** must exist
3) Amount must be valid cents, >= 500, and <= cashoutAvailableCents

If any gate fails, endpoint returns a **structured JSON** error body:
- message = cashout_failed
- detail = <human-readable reason>
…and the **HTTP status stays correct** (403/400/etc).

---

## Evidence / Proofs

### 1) TRUTH RUN (prod)
- Script: truth-run-prod.ps1
- Output log: truth-run-prod-20260129-014910.log
- Confirmed:
  - GET /health => 200
  - LOGIN owner/buyer/staff => JWT issued
  - /users/me (owner + buyer) OK
  - /auth/me (staff) OK
  - Optional: /wallet/summary (buyer) OK with ok=true

### 2) Gate enforcement (manual API calls, prod)
- POST /wallet/cashout (buyer) => 403 with:
  - message=cashout_failed
  - detail="Identity verification is required before cashouts."
- POST /wallet/cashout (owner) => 403 with same detail until identity is verified
- GET /wallet/bank-info:
  - buyer => 403 owner_only
  - owner => 200 {} (empty object)

---

## Files changed (R12)
- src/wallet/wallet.controller.ts

---

## Behavioral guardrails
- No changes to wallet arithmetic/ledger invariants in this patch
- Gating only blocks cashout until identity+bank gates satisfied
- Structured error body is stable for frontend, while preserving transport status

---

## Rollback
Revert commit:
- bde1bf3
